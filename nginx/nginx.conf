user www-data;
pid /run/nginx.pid;
worker_processes auto;
worker_rlimit_nofile 65535;

include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 4096;
	multi_accept on;
}

http {
  # charset                utf-8;
  # sendfile               on;
  # tcp_nopush             on;
  # tcp_nodelay            on;
  # server_tokens          off;
  # log_not_found          off;
  # types_hash_max_size    2048;
  # types_hash_bucket_size 64;
  # client_max_body_size   16M;

  ## proxy conf
  proxy_redirect          off;
  proxy_set_header        Host            $host;
  proxy_set_header        X-Real-IP       $remote_addr;
  proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
  client_max_body_size    10m;
  client_body_buffer_size 128k;
  proxy_connect_timeout   90;
  proxy_send_timeout      90;
  proxy_read_timeout      90;
  proxy_buffers           32 4k;

  ## fastcgi conf
  fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
  fastcgi_param  QUERY_STRING       $query_string;
  fastcgi_param  REQUEST_METHOD     $request_method;
  fastcgi_param  CONTENT_TYPE       $content_type;
  fastcgi_param  CONTENT_LENGTH     $content_length;
  fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
  fastcgi_param  REQUEST_URI        $request_uri;
  fastcgi_param  DOCUMENT_URI       $document_uri;
  fastcgi_param  DOCUMENT_ROOT      $document_root;
  fastcgi_param  SERVER_PROTOCOL    $server_protocol;
  fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
  fastcgi_param  SERVER_SOFTWARE    nginx/$nginx_version;
  fastcgi_param  REMOTE_ADDR        $remote_addr;
  fastcgi_param  REMOTE_PORT        $remote_port;
  fastcgi_param  SERVER_ADDR        $server_addr;
  fastcgi_param  SERVER_PORT        $server_port;
  fastcgi_param  SERVER_NAME        $server_name;
  fastcgi_index  index.php;
  fastcgi_param  REDIRECT_STATUS    200;
  
  # mime
  include                mime.types;
  default_type application/octet-stream;

  log_format   main '$remote_addr - $remote_user [$time_local]  $status '
    '"$request" $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for"';
  #access_log   logs/access.log  main;
  access_log  off;

  sendfile     on;
  tcp_nopush   on;
  server_names_hash_bucket_size 128; # this seems to be required for some vhosts

  server {
    listen 80 default_server;
    listen [::]:80 default_server;

    # SSL configuration
    #
    # listen 443 ssl default_server;
    # listen [::]:443 ssl default_server;
    #
    # Note: You should disable gzip for SSL traffic.
    # See: https://bugs.debian.org/773332
    #
    # Read up on ssl_ciphers to ensure a secure configuration.
    # See: https://bugs.debian.org/765782
    #
    # Self signed certs generated by the ssl-cert package
    # Don't use them in a production server!
    #
    # include snippets/snakeoil.conf;

    root /var/www/html;

    # Add index.php to the list if you are using PHP
    index index.html index.htm index.nginx-debian.html;

    location /grafana {
      rewrite ^/grafana/(.*)$ /$1  break;
      proxy_pass http://grafana:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      # include proxy_params;
    }

    location /prometheus {
      proxy_pass http://prometheus:9090;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      # include proxy_params;
    }

    # location /alertmanager {
    #         rewrite /alertmanager/(.*) /$1  break;
    #         proxy_pass http://alertmanager:9093;
    #         proxy_http_version 1.1;
    #         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # }

    location /opensearch {
      # rewrite ^/$ https://$host/opensearch-dashboards redirect; 
      # proxy_pass https://<os_domain_url>/_dashboards;
      proxy_pass http://opensearch:5601;
      proxy_cookie_domain opensearch $host;

      sub_filter_types *;
      sub_filter DOMAIN_ENDPOINT $host;
      sub_filter_once off;

      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_pass_header User-Agent;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      # include proxy_params;
    }

    # location ~ \/(log|sign|fav|forgot|change|saml|oauth2) {
      # proxy_redirect https://opensearch-dashboards:5601 https://$host;
    # }

    location / {
      # First attempt to serve request as file, then
      # as directory, then fall back to displaying a 404.
      try_files $uri $uri/ =404;
    }
  }

    # Load configs
  include                /etc/nginx/conf.d/*.conf;
  # include                /etc/nginx/sites-enabled/*;
}